<div class="content-header">
    <div class="content-title">資料管理</div>
</div>

<div class="admin-tabs">
    <button class="admin-tab-btn active" onclick="switchDataTab('issues')">開立事項管理</button>
    <button class="admin-tab-btn" onclick="switchDataTab('plans')">檢查計畫</button>
</div>

<!-- Tab 1: 開立事項管理 -->
<div id="tab-data-issues">
    <div class="admin-tabs" style="margin-bottom:20px; border-bottom:2px solid #e2e8f0;">
        <button class="admin-tab-btn active" onclick="switchIssuesSubTab('import')">批次匯入</button>
        <button class="admin-tab-btn" onclick="switchIssuesSubTab('create')">開立事項建檔</button>
        <button class="admin-tab-btn" onclick="switchIssuesSubTab('year-edit')">事項修正</button>
    </div>

    <!-- Sub-tab 1: Word Import -->
    <div id="subtab-issues-import">
        <!-- Part A: Word Import -->
        <div class="main-card" id="uploadCardWord" style="margin-bottom:30px;">
            <div style="margin-bottom:24px;">
                <h3 style="margin:0 0 8px 0; font-weight:700; font-size:18px; color:#334155;">📝 例行作業區 (Word 解析)</h3>
                <p style="margin:0; color:#64748b; font-size:13px;">
                    用於新增新的審查紀錄。請選擇本次的作業階段。
                </p>
            </div>

            <!-- Global Settings for Import -->
            <div
                style="background:white; border:1px solid #e2e8f0; padding:16px; border-radius:8px; margin-bottom:24px;">
                <label style="font-weight:700;display:block;margin-bottom:12px;color:var(--text-main);">1.
                    設定整批匯入參數 (必填)</label>

                <div style="margin-bottom:16px;">
                    <div style="font-size:13px;color:#64748b;margin-bottom:4px;">請選擇本次匯入的作業階段</div>
                    <div style="display:flex; gap:16px;">
                        <label
                            style="cursor:pointer; display:flex; align-items:center; gap:8px; background:#f0f9ff; padding:10px 16px; border-radius:8px; border:1px solid #bae6fd; color:#0369a1; flex:1;">
                            <input type="radio" name="importStage" value="initial" checked
                                onchange="onImportStageChange()">
                            <span style="font-weight:700;">初次開立 (新案)</span>
                        </label>
                        <label
                            style="cursor:pointer; display:flex; align-items:center; gap:8px; background:#fdf2f8; padding:10px 16px; border-radius:8px; border:1px solid #fbcfe8; color:#be185d; flex:1;">
                            <input type="radio" name="importStage" value="review"
                                onchange="onImportStageChange()">
                            <span style="font-weight:700;">後續審查 (第 N 次)</span>
                        </label>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:12px;">
                    <div id="importRoundContainer" style="display:none;">
                        <div style="font-size:13px;color:#64748b;margin-bottom:4px;">這是第幾次審查？</div>
                        <select id="importRoundSelect" class="filter-select">
                            <!-- JavaScript 會自動產生選項 -->
                        </select>
                    </div>

                    <div style="grid-column: span 2;" id="importPlanNameContainer">
                        <div style="font-size:13px;color:#64748b;margin-bottom:4px;">檢查計畫名稱 <span style="color:#ef4444;">*</span></div>
                        <select id="importPlanName" class="filter-select">
                            <option value="">請選擇計畫</option>
                            <!-- JavaScript 會自動產生選項 -->
                        </select>
                    </div>

                    <div style="grid-column: span 2;" id="importOwnerGroupContainer">
                        <div style="font-size:13px;color:#64748b;margin-bottom:4px;">管理群組 <span style="color:#ef4444;">*</span></div>
                        <select id="importOwnerGroup" class="filter-select">
                            <option value="">載入中…</option>
                        </select>
                    </div>
                </div>

                <!-- 日期欄位區塊 -->
                <div
                    style="background:#fafafa; padding:12px; border-radius:6px; border:1px dashed #cbd5e1;">
                    <div id="importDateGroup_Initial" style="display:block;">
                        <div style="font-size:13px;color:#0369a1;margin-bottom:4px;font-weight:600;">📆 日期設定
                            (初次開立)</div>
                        <div style="font-size:13px;color:#64748b;margin-bottom:4px;">監理機關初次發函日期 (例如:
                            1130615)</div>
                        <input type="text" id="importIssueDate" class="filter-input" placeholder="必填"
                            onkeyup="checkImportReady()" autocomplete="off">
                    </div>

                    <div id="importDateGroup_Review" style="display:none;">
                        <div style="font-size:13px;color:#be185d;margin-bottom:4px;font-weight:600;">📆 日期設定
                            (審查階段)</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                            <div>
                                <div style="font-size:13px;color:#64748b;margin-bottom:4px;">機構回復辦理情形日期
                                </div>
                                <input type="text" id="importReplyDate" class="filter-input"
                                    placeholder="例如: 1130701" autocomplete="off">
                            </div>
                            <div>
                                <div style="font-size:13px;color:#64748b;margin-bottom:4px;">監理機關本次函復日期
                                </div>
                                <input type="text" id="importResponseDate" class="filter-input"
                                    placeholder="例如: 1130715" autocomplete="off">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom:24px;">
                <label style="font-weight:700;display:block;margin-bottom:12px;color:var(--text-main);">2.
                    選擇 Word 檔案 (.docx)</label>
                <input type="file" id="wordInput" class="filter-input" accept=".docx"
                    style="padding:8px;">
            </div>
            <button id="btnParseWord" class="btn btn-primary" style="width:100%; padding:12px;"
                onclick="previewWord()" disabled>解析並預覽 Word</button>
            <div id="importStatusWord"
                style="margin-top:12px;color:#64748b;font-size:13px;text-align:center;"></div>
        </div>

        <!-- 備援/救援功能已移至「後台管理」 -->
    </div>

    <!-- Sub-tab 2: Create Issue (合併批次建檔和手動輸入) -->
    <div id="subtab-issues-create" class="hidden">
        <div class="main-card" style="width:100%;">
            <!-- 標題 -->
            <div style="margin-bottom:20px;">
                <h3 style="margin:0 0 8px 0; font-weight:700; font-size:18px; color:#334155;">📝 開立事項建檔</h3>
                <p style="margin:0; font-size:13px; color:#64748b;">
                    選擇計畫後，可連續輸入多筆事項。系統會自動根據編號判斷年度、機構與分組。可同時新增事項內容及多次辦理情形。
                </p>
            </div>

            <!-- 共用設定：檢查計畫和日期 -->
            <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:24px; border:1px solid #e2e8f0;">
                <div style="display:flex; gap:24px; align-items:flex-end; flex-wrap:wrap; margin-bottom:12px;">
                    <div style="flex: 2; min-width: 300px;">
                        <label style="display:block;font-weight:600;font-size:13px;margin-bottom:6px;color:#475569;">
                            檢查計畫名稱 <span style="color:#ef4444;">*</span>
                        </label>
                        <select id="createPlanName" class="filter-select" onchange="onCreatePlanChange(); handleCreateBatchPlanChange();">
                            <option value="">請選擇計畫</option>
                            <!-- JavaScript 會自動產生選項 -->
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display:block;font-weight:600;font-size:13px;margin-bottom:6px;color:#475569;">
                            管理群組 <span style="color:#ef4444;">*</span>
                        </label>
                        <select id="createOwnerGroup" class="filter-select">
                            <option value="">載入中…</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label style="display:block;font-weight:600;font-size:13px;margin-bottom:6px;color:#475569;">
                            初次發函日期 <span style="color:#ef4444;">*</span>
                        </label>
                        <input type="text" id="createIssueDate" class="filter-input" placeholder="例如: 1130501" autocomplete="off">
                    </div>
                </div>
                <!-- 載入現有事項按鈕 -->
                <div id="createLoadExistingContainer" style="display:none;">
                    <button class="btn btn-outline btn-sm" onclick="loadExistingIssuesToBatch()">
                        📥 載入該計畫下現有事項
                    </button>
                    <span style="font-size:13px; color:#64748b; margin-left:12px;">
                        💡 可載入該檢查計畫下已有的事項資料，方便繼續填寫新的辦理情形
                    </span>
                </div>
            </div>

            <!-- 開立事項建檔表格 -->
            <div id="createBatchMode" style="display:block;">
                <!-- 批次設定日期（回復日期和函復日期） -->
                <div style="background:#f8fafc; padding:16px; border-radius:12px; margin-bottom:20px; border:1px solid #e2e8f0;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:600; color:#334155; font-size:13px; margin-bottom:12px;">
                        <input type="checkbox" id="createBatchReplyDateToggle" onchange="toggleBatchReplyDateSetting()" style="width:18px; height:18px; cursor:pointer;">
                        <span>📅 設定辦理情形回復日期（選填）</span>
                    </label>
                    <div id="createBatchReplyDateContainer" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid #e2e8f0;">
                        <div style="font-size:13px; color:#64748b; margin-bottom:12px;">
                            💡 可為所有事項的辦理情形設定相同的回復日期。
                        </div>
                        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                            <div style="display:flex; gap:8px; align-items:center;">
                                <label style="font-size:13px; color:#475569; font-weight:600;">第幾次回復：</label>
                                <select id="createBatchReplyRound" class="filter-select" style="width:140px;" onchange="onBatchReplyRoundChange()">
                                    <option value="">請選擇</option>
                                    <!-- JavaScript 會動態產生選項（最多200次） -->
                                </select>
                                <span style="font-size:13px; color:#64748b;">或</span>
                                <input type="number" id="createBatchReplyRoundManual" class="filter-input" 
                                    placeholder="手動輸入" min="1" max="200" 
                                    style="width:100px;"
                                    onchange="onBatchReplyRoundManualChange()" autocomplete="off">
                            </div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <label style="font-size:13px; color:#475569; font-weight:600;">回復日期：</label>
                                <input type="text" id="createBatchReplyDate" class="filter-input" placeholder="例如: 1130601" 
                                    style="width:150px;" autocomplete="off">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="batchSetReplyDateForAll()">設定</button>
                        </div>
                    </div>
                    
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:600; color:#334155; font-size:13px; margin-top:16px; margin-bottom:12px;">
                        <input type="checkbox" id="createBatchResponseDateToggle" onchange="toggleBatchResponseDateSetting()" style="width:18px; height:18px; cursor:pointer;">
                        <span>📅 設定審查函復日期（選填）</span>
                    </label>
                    <div id="createBatchResponseDateContainer" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid #e2e8f0;">
                        <div style="font-size:13px; color:#64748b; margin-bottom:12px;">
                            💡 可為該檢查計畫下所有事項設定函復日期。通常在審查完成後使用。
                        </div>
                        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                            <div style="display:flex; gap:8px; align-items:center;">
                                <label style="font-size:13px; color:#475569; font-weight:600;">第幾次審查函復：</label>
                                <select id="createBatchResponseRound" class="filter-select" style="width:140px;" onchange="onBatchResponseRoundChange()">
                                    <option value="">請選擇</option>
                                    <!-- JavaScript 會動態產生選項（最多200次） -->
                                </select>
                                <span style="font-size:13px; color:#64748b;">或</span>
                                <input type="number" id="createBatchResponseRoundManual" class="filter-input" 
                                    placeholder="手動輸入" min="1" max="200" 
                                    style="width:100px;"
                                    onchange="onBatchResponseRoundManualChange()" autocomplete="off">
                            </div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <label style="font-size:13px; color:#475569; font-weight:600;">函復日期：</label>
                                <input type="text" id="createBatchResponseDate" class="filter-input" placeholder="例如: 1130615 或 1141001" 
                                    style="width:150px;" autocomplete="off">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="batchSetResponseDateForPlan()">設定</button>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex:1; display:flex; align-items:center; color:#64748b; font-size:13px;">
                        💡 提示：輸入編號後，按下 Enter 或 離開欄位，系統會自動帶入相關欄位。可為每筆事項新增辦理情形。
                    </div>
                    <button class="btn btn-outline" onclick="initCreateBatchGrid()" style="padding:8px 16px;">重置表格</button>
                </div>
                
                <div class="main-card" style="box-shadow:none; border:1px solid #e2e8f0;">
                    <div class="data-container" style="overflow-x:auto;">
                        <table id="createBatchGridTable">
                            <thead>
                                <tr>
                                    <th style="width:60px;">項次</th>
                                    <th style="width:180px;">編號</th>
                                    <th style="min-width:250px;">事項內容</th>
                                    <th style="width:90px;">年度</th>
                                    <th style="width:120px;">機構</th>
                                    <th style="width:100px;">分組</th>
                                    <th style="width:120px;">檢查種類</th>
                                    <th style="width:100px;">類型</th>
                                    <th style="width:110px;">狀態</th>
                                    <th style="width:120px;">辦理情形</th>
                                    <th style="width:60px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="createBatchGridBody">
                                <!-- Rows generated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div style="padding:16px; border-top:1px solid #e2e8f0; background:#f8fafc; display:flex; justify-content:center;">
                        <button class="btn btn-outline" style="width:100%; border-style:dashed;" onclick="addCreateBatchRow()">
                            新增一列
                        </button>
                    </div>
                </div>
                <div style="margin-top:24px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
                    <div style="display:flex; gap:12px; align-items:center; padding:12px; background:#f8fafc; border-radius:8px;">
                        <label style="font-size:13px; color:#2563eb; display:flex; align-items:center; gap:6px; cursor:pointer;">
                            <input type="checkbox" id="createBatchContinuousMode"> 連續新增模式 (儲存後自動新增新列，保留計畫與機構)
                        </label>
                    </div>
                    <button class="btn btn-primary" style="padding:12px 32px;" onclick="saveCreateBatchItems()">
                        💾 上傳至資料庫
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab 3: Year Edit -->
    <div id="subtab-issues-year-edit" class="hidden">
        <div class="main-card">
            <div style="margin-bottom:24px;">
                <h3 style="margin:0 0 8px 0; color:#334155; font-size:18px;">📝 開立事項修正</h3>
                <p style="color:#64748b; font-size:13px; margin:0;">選擇檢查計畫後，可查看該計畫下的所有事項，點選後可編輯該事項的全部內容，包括所有審查及回復紀錄。</p>
            </div>
            
            <!-- 選擇檢查計畫（下拉選單，類似查詢看板） -->
            <div style="background:#f8fafc; padding:20px; border-radius:8px; margin-bottom:24px; border:1px solid #e2e8f0;">
                <div>
                    <label style="display:block; font-weight:600; color:#475569; font-size:13px; margin-bottom:8px;">檢查計畫 <span style="color:#ef4444;">*</span></label>
                    <select id="yearEditPlanName" class="filter-select" onchange="onYearEditPlanChange()" style="width:100%;">
                        <option value="">載入中...</option>
                        <!-- JavaScript 會自動產生選項 -->
                    </select>
                </div>
            </div>
            
            <!-- 事項列表 -->
            <div id="yearEditIssueList" style="display:none; margin-bottom:24px;">
                <div style="margin-bottom:12px; font-weight:600; color:#334155; font-size:15px;">
                    事項列表（共 <span id="yearEditIssueListCount">0</span> 項）
                </div>
                <div id="yearEditIssueListContainer" style="border:1px solid #e2e8f0; border-radius:8px; background:#fff;">
                    <!-- 事項列表將由 JavaScript 動態生成 -->
                </div>
            </div>
            
            <!-- 事項詳細內容 -->
            <div id="yearEditIssueContent" style="display:none;">
                <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center;">
                    <button class="btn btn-outline" onclick="backToYearEditIssueList()" style="padding:8px 16px;">
                        ← 返回事項列表
                    </button>
                    <div style="padding:12px; background:#fef3c7; border:1px solid #fcd34d; border-radius:6px; flex:1; margin-left:16px;">
                        <div style="font-size:13px; color:#92400e;">
                            <strong>💡 提示：</strong>修改下方內容後，點擊「儲存變更」按鈕即可儲存。可編輯：基本資訊、事項內容、狀態、所有輪次的辦理情形與審查意見。
                        </div>
                    </div>
                </div>
                
                <div id="yearEditIssueContainer">
                    <!-- 事項詳細內容將由 JavaScript 動態生成 -->
                </div>
                
                <div style="margin-top:24px; padding:20px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;">
                    <button class="btn btn-success" onclick="saveYearEditIssue()" id="yearEditSaveBtn" style="width:100%; padding:14px;">💾 上傳至資料庫</button>
                </div>
            </div>
            
            <div id="yearEditEmpty" style="text-align:center; padding:60px 20px; color:#94a3b8; display:block;">
                <div style="font-size:48px; margin-bottom:16px;">🔍</div>
                <div style="font-size:16px; font-weight:500; margin-bottom:8px;">請選擇檢查計畫</div>
                <div style="font-size:13px;">選擇後將自動顯示該計畫下的所有事項</div>
            </div>
            
            <div id="yearEditNotFound" style="text-align:center; padding:60px 20px; color:#ef4444; display:none;">
                <div style="font-size:48px; margin-bottom:16px;">📭</div>
                <div style="font-size:16px; font-weight:500; margin-bottom:8px;">該檢查計畫下尚無開立事項</div>
                <div style="font-size:13px;">請選擇其他檢查計畫</div>
            </div>
        </div>
    </div>
</div>

<!-- Tab: 檢查計畫（合併管理與規劃） -->
<div id="tab-data-plans" class="hidden">
    <div class="admin-tabs" style="margin-bottom:20px; border-bottom:2px solid #e2e8f0;">
        <button class="admin-tab-btn active" onclick="switchPlansSubTab('schedule')">行程規劃</button>
        <button class="admin-tab-btn" onclick="switchPlansSubTab('manage')">計畫管理</button>
    </div>

    <!-- Sub-tab 1: 行程規劃（月曆型） -->
    <div id="subtab-plans-schedule">
    <div class="main-card">
        <div style="margin-bottom:20px;">
            <h3 style="margin:0 0 8px 0; font-weight:700; font-size:18px; color:#334155;">📅 檢查行程規劃</h3>
            <p style="margin:0; color:#64748b; font-size:13px;">
                以月曆排程規劃檢查日期，填寫檢查行程後，系統會自動取號。
            </p>
        </div>
        <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
            <div style="flex:1; min-width:280px;">
                <div class="schedule-calendar-toolbar" style="display:flex; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
                    <button type="button" class="btn btn-outline" id="schedulePrevMonth" onclick="schedulePrevMonth()">◀ 上個月</button>
                    <span id="scheduleMonthTitle" style="font-weight:700; font-size:16px; color:#334155;">— 年 — 月</span>
                    <button type="button" class="btn btn-outline" id="scheduleNextMonth" onclick="scheduleNextMonth()">下個月 ▶</button>
                    <button type="button" class="btn btn-primary" onclick="printScheduleCalendar()">🖨️ 列印月曆</button>
                </div>
                <div id="scheduleCalendar" class="schedule-calendar"></div>
                <div id="scheduleDayList" style="margin-top:16px; padding:16px; background:#f8fafc; border-radius:10px; border:1px solid #e2e8f0;">
                    <div style="font-weight:600; font-size:14px; color:#334155; margin-bottom:8px;">當日排程</div>
                    <div id="scheduleDayListBody" style="font-size:13px; color:#64748b;">點選月曆日期後顯示</div>
                </div>
            </div>
            <div style="width:360px; flex-shrink:0;">
                <div style="background:#f8fafc; padding:20px; border-radius:12px; border:1px solid #e2e8f0;">
                    <div style="font-weight:700; font-size:15px; color:#334155; margin-bottom:16px;">填寫檢查行程</div>
                    <input type="hidden" id="scheduleSelectedDate">
                    <div class="form-group" style="margin-bottom:12px;">
                        <label>年度</label>
                        <select id="scheduleYearFilter" class="filter-select" onchange="onScheduleYearFilterChange()">
                            <option value="">全部年度</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>檢查計畫 <span style="color:#ef4444;">*</span></label>
                        <select id="schedulePlanSelect" class="filter-select">
                            <option value="">請選擇已建立的檢查計畫</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>管理群組（依計畫）</label>
                        <select id="scheduleOwnerGroup" class="filter-select" disabled>
                            <option value="">—</option>
                        </select>
                        <div style="margin-top:6px; font-size:12px; color:#64748b;">行程歸屬會跟隨所選計畫。</div>
                    </div>
                    <div id="schedulePlanInfo" style="display:none; background:#f0f9ff; padding:12px; border-radius:6px; margin-bottom:16px; border:1px solid #bae6fd;">
                        <div style="font-size:12px; color:#0369a1; font-weight:600; margin-bottom:6px;">已讀取計畫資訊：</div>
                        <div style="font-size:12px; color:#0c4a6e;">
                            <div>鐵路機構：<span id="schedulePlanRailway" style="font-weight:600;">-</span></div>
                            <div>檢查類別：<span id="schedulePlanInspectionType" style="font-weight:600;">-</span></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>開始日期 <span style="color:#ef4444;">*</span></label>
                        <input type="date" id="scheduleStartDate" class="filter-input" required>
                    </div>
                    <div class="form-group">
                        <label>結束日期 <span style="color:#ef4444;">*</span></label>
                        <input type="date" id="scheduleEndDate" class="filter-input" required>
                    </div>
                    <div class="form-group">
                        <label>地點 <span style="color:#ef4444;">*</span></label>
                        <input type="text" id="scheduleLocation" class="filter-input" placeholder="例如：臺北車站" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label>檢查人員 <span style="color:#ef4444;">*</span></label>
                        <input type="text" id="scheduleInspector" class="filter-input" placeholder="例如：張三、李四" autocomplete="off">
                    </div>
                    <div id="schedulePlanNumberDisplay" style="display:none; margin:-6px 0 14px; color:#92400e; font-weight:700;">
                        <span style="margin-right:6px;">🔢</span>
                        <span>取號編號：</span>
                        <span id="schedulePlanNumberValue" style="font-family:'Courier New',monospace;">-</span>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button type="button" class="btn btn-primary" style="flex:1;" onclick="scheduleSubmitPlan()">上傳至資料庫</button>
                        <button type="button" class="btn btn-outline" onclick="scheduleClearForm()">清空</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Sub-tab 2: 計畫管理 -->
    <div id="subtab-plans-manage" class="hidden">
    <div class="main-card">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px; flex-wrap:wrap; gap:12px;">
            <div style="flex:1; min-width:200px;">
                <h3 style="margin:0 0 8px 0; font-weight:700; font-size:18px; color:#334155;">檢查計畫管理</h3>
                <p style="margin:0; color:#64748b; font-size:13px;">管理檢查計畫資料，可新增、編輯、刪除檢查計畫，並支援 Excel 整批匯入。</p>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start;">
                <button class="btn btn-primary" onclick="openPlanModal('create')">➕ 新增計畫</button>
                <button class="btn btn-outline" onclick="openPlanImportModal()">📥 整批匯入</button>
            </div>
        </div>
        <div style="padding:16px; display:flex; gap:12px; align-items:center; border-bottom:1px solid var(--border); flex-wrap:wrap;">
            <input id="planSearch" class="filter-input" placeholder="搜尋計畫名稱..." style="max-width:300px;" oninput="loadPlansPage(1)" autocomplete="off">
            <select id="planYearFilter" class="filter-select" style="width:120px;" onchange="loadPlansPage(1)">
                <option value="">全部年度</option>
            </select>
            <div style="margin-left:auto;">
                <button class="btn btn-outline" onclick="loadPlansPage(1)">搜尋</button>
            </div>
        </div>
        <div class="control-row-actions" style="padding:16px; border-bottom:1px solid var(--border);">
            <div style="display:flex; gap:12px; align-items:center;">
                <div id="plansBatchActionContainer" style="display:none;">
                    <button class="btn btn-danger btn-sm" onclick="batchDeletePlans()">批次刪除 <span id="selectedPlansCountBadge"></span></button>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                <select id="plansPageSize" class="page-size-select" onchange="loadPlansPage(1)">
                    <option value="10">10 筆/頁</option>
                    <option value="20" selected>20 筆/頁</option>
                    <option value="50">50 筆/頁</option>
                </select>
                <div id="plansPaginationTop" class="pagination-bar"></div>
            </div>
        </div>
        <div class="data-container">
            <table class="user-table">
                <thead>
                    <tr>
                        <th style="width:50px;"><input type="checkbox" id="selectAllPlans" onchange="toggleSelectAllPlans()"></th>
                        <th onclick="plansSortBy('year')">年度</th>
                        <th style="padding:12px; min-width:100px;">檢查類別</th>
                        <th style="padding:16px;" onclick="plansSortBy('name')">檢查計畫名稱</th>
                        <th style="min-width:100px;">業務類型</th>
                        <th style="min-width:90px;">規劃次數</th>
                        <th style="min-width:90px;">已檢查次數</th>
                        <th style="min-width:200px;">檢查起訖日期</th>
                        <th style="min-width:150px;">地點</th>
                        <th style="min-width:150px;">檢查人員</th>
                        <th style="min-width:180px;">取號編碼</th>
                        <th>開立事項數量</th>
                        <th onclick="plansSortBy('created_at')">建立日期</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="plansTableBody"></tbody>
            </table>
        </div>
        <div id="plansPaginationBottom" class="pagination-bar" style="padding:16px; justify-content: center;"></div>
    </div>
    </div>

    <!-- Plan Modal（共用）－重新設計編輯視窗 -->
    <div class="modal-overlay" id="planModal">
        <div class="modal-box plan-edit-modal plan-edit-modal-v2">
            <div class="plan-modal-header">
                <h3 id="planModalTitle">編輯檢查計畫</h3>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button type="button" class="btn btn-outline btn-sm" onclick="openPlanEditorsModal()">👥 協作編修</button>
                <button type="button" class="plan-modal-close" onclick="closePlanModal()" aria-label="關閉">×</button>
                </div>
            </div>
            <input type="hidden" id="targetPlanId">
            <input type="hidden" id="targetScheduleId">
            <div class="plan-modal-body">
                <section class="plan-form-section">
                    <div class="plan-section-title"><span class="plan-section-icon">📋</span> 基本資料</div>
                    <div class="plan-form-row">
                        <div class="form-group plan-form-half">
                            <label>年度（民國） <span class="required">*</span></label>
                            <input type="text" id="planYear" class="filter-input" placeholder="例如: 113" autocomplete="off">
                        </div>
                        <div class="form-group plan-form-half">
                            <label>計畫名稱 <span class="required">*</span></label>
                            <input type="text" id="planName" class="filter-input" placeholder="例如: 上半年定期檢查" autocomplete="off">
                        </div>
                    </div>
                    <div class="plan-form-row">
                        <div class="form-group plan-form-half">
                            <label>管理群組 <span class="required">*</span></label>
                            <select id="planOwnerGroup" class="filter-select">
                                <option value="">載入中…</option>
                            </select>
                            <div style="margin-top:6px; font-size:12px; color:#64748b;">
                                決定此計畫由哪個群組負責（同群組可編輯）。
                            </div>
                        </div>
                        <div class="form-group plan-form-half" style="display:flex; align-items:flex-end;">
                            <div style="width:100%; color:#64748b; font-size:12px; line-height:1.6; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:10px; padding:10px 12px;">
                                提示：若你要「僅承辦可改」模式，後續可再加鎖定功能。
                            </div>
                        </div>
                    </div>
                    <div class="plan-form-row">
                        <div class="form-group plan-form-half" id="planDetailsGroup">
                            <label>鐵路機構 <span class="required">*</span></label>
                            <select id="planRailway" class="filter-select">
                                <option value="">請選擇</option>
                                <option value="T">臺鐵</option>
                                <option value="H">高鐵</option>
                                <option value="A">林鐵</option>
                                <option value="S">糖鐵</option>
                            </select>
                        </div>
                        <div class="form-group plan-form-half" id="planDetailsGroup2">
                            <label>檢查類別 <span class="required">*</span></label>
                            <select id="planInspectionType" class="filter-select">
                                <option value="">請選擇</option>
                                <option value="1">年度定期檢查</option>
                                <option value="2">特別檢查</option>
                                <option value="3">例行性檢查</option>
                                <option value="4">臨時檢查</option>
                            </select>
                        </div>
                    </div>
                    <div class="plan-form-row">
                        <div class="form-group plan-form-half" id="planBusinessGroup">
                            <label>業務類型</label>
                            <select id="planBusiness" class="filter-select">
                                <option value="">請選擇</option>
                                <option value="OP">運轉</option>
                                <option value="CV">土建</option>
                                <option value="ME">機務</option>
                                <option value="EL">電務</option>
                                <option value="SM">安全管理</option>
                                <option value="AD">營運／災防審核</option>
                                <option value="OT">其他／產管規劃</option>
                            </select>
                        </div>
                        <div class="form-group plan-form-half" id="planPlannedCountGroup">
                            <label>規劃檢查幾次</label>
                            <input type="number" id="planPlannedCount" class="filter-input" min="0" placeholder="僅填數字" autocomplete="off">
                        </div>
                    </div>
                </section>
                <section class="plan-form-section plan-dates-section-sticky" id="planDatesSection">
                    <div class="plan-section-title"><span class="plan-section-icon">📅</span> 目前編輯的行程（點選下方一筆後可編輯日期、地點、人員、取號編碼）</div>
                    <div class="plan-form-row">
                        <div class="form-group plan-form-half" id="planStartDateGroup">
                            <label>開始日期 <span class="required">*</span></label>
                            <input type="date" id="planStartDate" class="filter-input">
                        </div>
                        <div class="form-group plan-form-half" id="planEndDateGroup">
                            <label>結束日期 <span class="required">*</span></label>
                            <input type="date" id="planEndDate" class="filter-input">
                        </div>
                    </div>
                    <div class="plan-form-row" id="planLocationInspectorRow">
                        <div class="form-group plan-form-half">
                            <label>地點</label>
                            <input type="text" id="planLocation" class="filter-input" placeholder="檢查地點" autocomplete="off">
                        </div>
                        <div class="form-group plan-form-half">
                            <label>檢查人員</label>
                            <input type="text" id="planInspector" class="filter-input" placeholder="檢查人員" autocomplete="off">
                        </div>
                    </div>
                    <div class="plan-form-row" id="planNumberRow" style="display:none;">
                        <div class="form-group" style="flex:1;">
                            <label>取號編碼</label>
                            <input type="text" id="planScheduleNumber" class="filter-input" placeholder="可手動修改，請確認無重複" style="font-family:monospace; font-weight:600;" autocomplete="off">
                            <div class="plan-number-warn" style="font-size:12px; color:#b45309; margin-top:6px;">⚠️ 若手動修改編號，請確認無重複後再儲存。</div>
                        </div>
                    </div>
                </section>
                <section class="plan-form-section" id="planSchedulesSection">
                    <div class="plan-section-title"><span class="plan-section-icon">📌</span> 此計畫的檢查行程（點選一筆後於上方編輯）</div>
                    <div id="planSchedulesList" class="plan-schedules-list plan-schedules-list-no-scroll">
                        <div class="plan-schedules-empty">尚未有檢查行程，請先至「填寫檢查行程」或在此建立第一筆行程。</div>
                    </div>
                </section>
            </div>
            <div class="plan-modal-footer">
                <button class="btn btn-primary" onclick="submitPlan()">儲存</button>
                <button class="btn btn-outline" onclick="closePlanModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- Plan Import Modal（共用） -->
    <div class="modal-overlay" id="planImportModal">
        <div class="modal-box" style="max-width:600px;">
            <h3 style="margin-top:0;">整批匯入檢查計畫（Excel）</h3>
            <div class="form-group">
                <label>選擇匯入檔案（.xlsx）</label>
                <input type="file" id="planImportFile" accept=".xlsx" class="filter-input">
            </div>
            <div style="display:flex;gap:12px;margin-top:24px;">
                <button class="btn btn-primary" style="flex:1;" onclick="importPlansXlsx()">📥 執行匯入</button>
                <button class="btn btn-outline" style="flex:1;" onclick="closePlanImportModal()">取消</button>
                <button class="btn btn-outline" style="flex:1;" onclick="downloadPlanXlsxTemplate()">📥 下載 Excel 範例</button>
            </div>
        </div>
    </div>
</div>
