<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSRF ä¿è­·æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
        .test-section h2 {
            margin-top: 0;
            color: #2196F3;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        button.info {
            background: #2196F3;
        }
        button.info:hover {
            background: #0b7dda;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .warning {
            color: #ff9800;
            font-weight: bold;
        }
        .info {
            color: #2196F3;
        }
        .test-item {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        .test-item h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.pending {
            background: #ff9800;
            color: white;
        }
        .status.success {
            background: #4CAF50;
            color: white;
        }
        .status.failed {
            background: #f44336;
            color: white;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
        .summary h2 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ CSRF ä¿è­·æ¸¬è©¦å·¥å…·</h1>
        
        <div class="test-section">
            <h2>å¿«é€Ÿæ¸¬è©¦</h2>
            <p>è«‹å…ˆç¢ºä¿æ‚¨å·²ç¶“ç™»å…¥ç³»çµ±ï¼Œç„¶å¾Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œæ¸¬è©¦ã€‚</p>
            <button onclick="runAllTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
            <button onclick="testWithoutToken()" class="danger">æ¸¬è©¦æ²’æœ‰ CSRF Token</button>
            <button onclick="testWithToken()" class="info">æ¸¬è©¦æœ‰ CSRF Token</button>
            <button onclick="testGetRequest()" class="info">æ¸¬è©¦ GET è«‹æ±‚ï¼ˆä¸éœ€è¦ Tokenï¼‰</button>
            <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
        </div>

        <div class="test-section">
            <h2>è©³ç´°æ¸¬è©¦é …ç›®</h2>
            
            <div class="test-item">
                <h3>1. GET è«‹æ±‚ä¸éœ€è¦ CSRF token <span id="test1-status" class="status pending">å¾…æ¸¬è©¦</span></h3>
                <p>æ¸¬è©¦ GET /api/users è«‹æ±‚ï¼Œæ‡‰è©²æ­£å¸¸é‹ä½œä¸”ä¸éœ€è¦ CSRF tokenã€‚</p>
                <button onclick="test1()">åŸ·è¡Œæ¸¬è©¦</button>
            </div>

            <div class="test-item">
                <h3>2. POST è«‹æ±‚æ²’æœ‰ CSRF token æ‡‰è©²è¢«æ‹’çµ• <span id="test2-status" class="status pending">å¾…æ¸¬è©¦</span></h3>
                <p>æ¸¬è©¦ POST /api/users è«‹æ±‚ï¼ˆæ²’æœ‰ tokenï¼‰ï¼Œæ‡‰è©²æ”¶åˆ° 403 éŒ¯èª¤ã€‚</p>
                <button onclick="test2()">åŸ·è¡Œæ¸¬è©¦</button>
            </div>

            <div class="test-item">
                <h3>3. POST è«‹æ±‚æœ‰ CSRF token æ‡‰è©²æ­£å¸¸é‹ä½œ <span id="test3-status" class="status pending">å¾…æ¸¬è©¦</span></h3>
                <p>æ¸¬è©¦ POST /api/users è«‹æ±‚ï¼ˆæœ‰ tokenï¼‰ï¼Œæ‡‰è©²æ­£å¸¸é‹ä½œæˆ–æ”¶åˆ°æ¥­å‹™é‚è¼¯éŒ¯èª¤ï¼ˆä¸æ˜¯ CSRF éŒ¯èª¤ï¼‰ã€‚</p>
                <button onclick="test3()">åŸ·è¡Œæ¸¬è©¦</button>
            </div>

            <div class="test-item">
                <h3>4. PUT è«‹æ±‚æ²’æœ‰ CSRF token æ‡‰è©²è¢«æ‹’çµ• <span id="test4-status" class="status pending">å¾…æ¸¬è©¦</span></h3>
                <p>æ¸¬è©¦ PUT è«‹æ±‚ï¼ˆæ²’æœ‰ tokenï¼‰ï¼Œæ‡‰è©²æ”¶åˆ° 403 éŒ¯èª¤ã€‚</p>
                <button onclick="test4()">åŸ·è¡Œæ¸¬è©¦</button>
            </div>

            <div class="test-item">
                <h3>5. DELETE è«‹æ±‚æ²’æœ‰ CSRF token æ‡‰è©²è¢«æ‹’çµ• <span id="test5-status" class="status pending">å¾…æ¸¬è©¦</span></h3>
                <p>æ¸¬è©¦ DELETE è«‹æ±‚ï¼ˆæ²’æœ‰ tokenï¼‰ï¼Œæ‡‰è©²æ”¶åˆ° 403 éŒ¯èª¤ã€‚</p>
                <button onclick="test5()">åŸ·è¡Œæ¸¬è©¦</button>
            </div>

            <div class="test-item">
                <h3>6. ç™»å…¥è·¯ç”±ä¸éœ€è¦ CSRF token <span id="test6-status" class="status pending">å¾…æ¸¬è©¦</span></h3>
                <p>æ¸¬è©¦ POST /api/auth/login è«‹æ±‚ï¼ˆæ²’æœ‰ tokenï¼‰ï¼Œæ‡‰è©²æ­£å¸¸é‹ä½œï¼ˆç™»å…¥æˆåŠŸæˆ–å¤±æ•—ï¼Œä½†ä¸æ˜¯ CSRF éŒ¯èª¤ï¼‰ã€‚</p>
                <button onclick="test6()">åŸ·è¡Œæ¸¬è©¦</button>
            </div>

            <div class="test-item">
                <h3>7. å‰ç«¯è‡ªå‹•å–å¾— CSRF token <span id="test7-status" class="status pending">å¾…æ¸¬è©¦</span></h3>
                <p>æ¸¬è©¦æ˜¯å¦å¯ä»¥æˆåŠŸå–å¾— CSRF tokenã€‚</p>
                <button onclick="test7()">åŸ·è¡Œæ¸¬è©¦</button>
            </div>
        </div>

        <div id="result"></div>

        <div class="summary" id="summary" style="display: none;">
            <h2>æ¸¬è©¦æ‘˜è¦</h2>
            <div id="summary-content"></div>
        </div>
    </div>

    <script>
        let testResults = {};

        function log(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : (type === 'warning' ? 'warning' : 'info'));
            resultDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('result').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            // é‡ç½®æ‰€æœ‰ç‹€æ…‹
            for (let i = 1; i <= 7; i++) {
                const statusEl = document.getElementById(`test${i}-status`);
                if (statusEl) {
                    statusEl.textContent = 'å¾…æ¸¬è©¦';
                    statusEl.className = 'status pending';
                }
            }
            testResults = {};
        }

        function updateTestStatus(testNum, status, message) {
            const statusEl = document.getElementById(`test${testNum}-status`);
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status ${status}`;
            }
            testResults[testNum] = { status, message };
            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r.status === 'success').length;
            const failed = Object.values(testResults).filter(r => r.status === 'failed').length;
            
            if (total > 0) {
                summaryDiv.style.display = 'block';
                summaryContent.innerHTML = `
                    <p><strong>ç¸½æ¸¬è©¦æ•¸ï¼š</strong> ${total}</p>
                    <p class="success"><strong>é€šéï¼š</strong> ${passed}</p>
                    <p class="error"><strong>å¤±æ•—ï¼š</strong> ${failed}</p>
                    <p><strong>é€šéç‡ï¼š</strong> ${total > 0 ? Math.round((passed / total) * 100) : 0}%</p>
                `;
            }
        }

        async function getCsrfToken() {
            try {
                const res = await fetch('/api/csrf-token', {
                    credentials: 'include'
                });
                if (res.ok) {
                    const data = await res.json();
                    return data.csrfToken;
                }
            } catch (e) {
                log(`å–å¾— CSRF token å¤±æ•—: ${e.message}`, 'error');
            }
            return null;
        }

        // æ¸¬è©¦ 1: GET è«‹æ±‚ä¸éœ€è¦ CSRF token
        async function test1() {
            log('é–‹å§‹æ¸¬è©¦ 1: GET è«‹æ±‚ä¸éœ€è¦ CSRF token...', 'info');
            try {
                const res = await fetch('/api/users', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    log(`âœ“ æ¸¬è©¦é€šé: GET è«‹æ±‚æˆåŠŸï¼Œä¸éœ€è¦ CSRF token`, 'success');
                    log(`  å›æ‡‰: ${JSON.stringify(data).substring(0, 100)}...`, 'info');
                    updateTestStatus(1, 'success', 'é€šé');
                } else {
                    log(`âœ— æ¸¬è©¦å¤±æ•—: GET è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ ${res.status}`, 'error');
                    updateTestStatus(1, 'failed', 'å¤±æ•—');
                }
            } catch (e) {
                log(`âœ— æ¸¬è©¦å¤±æ•—: ${e.message}`, 'error');
                updateTestStatus(1, 'failed', 'å¤±æ•—');
            }
        }

        // æ¸¬è©¦ 2: POST è«‹æ±‚æ²’æœ‰ CSRF token æ‡‰è©²è¢«æ‹’çµ•
        async function test2() {
            log('é–‹å§‹æ¸¬è©¦ 2: POST è«‹æ±‚æ²’æœ‰ CSRF token æ‡‰è©²è¢«æ‹’çµ•...', 'info');
            try {
                const res = await fetch('/api/users', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                        // æ•…æ„ä¸åŠ å…¥ X-CSRF-Token
                    },
                    body: JSON.stringify({
                        username: 'test_csrf_' + Date.now(),
                        password: 'Test1234',
                        name: 'CSRF æ¸¬è©¦',
                        role: 'viewer'
                    })
                });
                
                const data = await res.json();
                
                if (res.status === 403 && (data.error && data.error.includes('CSRF'))) {
                    log(`âœ“ æ¸¬è©¦é€šé: POST è«‹æ±‚æ²’æœ‰ token è¢«æ­£ç¢ºæ‹’çµ• (403)`, 'success');
                    log(`  éŒ¯èª¤è¨Šæ¯: ${data.error}`, 'info');
                    updateTestStatus(2, 'success', 'é€šé');
                } else {
                    log(`âœ— æ¸¬è©¦å¤±æ•—: é æœŸ 403 CSRF éŒ¯èª¤ï¼Œä½†æ”¶åˆ°ç‹€æ…‹ç¢¼ ${res.status}`, 'error');
                    log(`  å›æ‡‰: ${JSON.stringify(data)}`, 'error');
                    updateTestStatus(2, 'failed', 'å¤±æ•—');
                }
            } catch (e) {
                log(`âœ— æ¸¬è©¦å¤±æ•—: ${e.message}`, 'error');
                updateTestStatus(2, 'failed', 'å¤±æ•—');
            }
        }

        // æ¸¬è©¦ 3: POST è«‹æ±‚æœ‰ CSRF token æ‡‰è©²æ­£å¸¸é‹ä½œ
        async function test3() {
            log('é–‹å§‹æ¸¬è©¦ 3: POST è«‹æ±‚æœ‰ CSRF token æ‡‰è©²æ­£å¸¸é‹ä½œ...', 'info');
            try {
                const token = await getCsrfToken();
                if (!token) {
                    log(`âœ— æ¸¬è©¦å¤±æ•—: ç„¡æ³•å–å¾— CSRF token`, 'error');
                    updateTestStatus(3, 'failed', 'å¤±æ•—');
                    return;
                }
                
                log(`å–å¾— CSRF token: ${token.substring(0, 20)}...`, 'info');
                
                const res = await fetch('/api/users', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': token
                    },
                    body: JSON.stringify({
                        username: 'test_csrf_' + Date.now(),
                        password: 'Test1234',
                        name: 'CSRF æ¸¬è©¦',
                        role: 'viewer'
                    })
                });
                
                const data = await res.json();
                
                // å¦‚æœæˆåŠŸï¼ˆ200ï¼‰æˆ–æ”¶åˆ°æ¥­å‹™é‚è¼¯éŒ¯èª¤ï¼ˆ400/500ï¼‰ï¼Œä½†ä¸æ˜¯ CSRF éŒ¯èª¤ï¼ˆ403ï¼‰ï¼Œå‰‡æ¸¬è©¦é€šé
                if (res.status === 403 && data.error && data.error.includes('CSRF')) {
                    log(`âœ— æ¸¬è©¦å¤±æ•—: å³ä½¿æœ‰ token ä»æ”¶åˆ° CSRF éŒ¯èª¤`, 'error');
                    updateTestStatus(3, 'failed', 'å¤±æ•—');
                } else if (res.status === 200 || res.status === 400 || res.status === 500) {
                    log(`âœ“ æ¸¬è©¦é€šé: POST è«‹æ±‚æœ‰ token æ­£å¸¸é‹ä½œ`, 'success');
                    log(`  ç‹€æ…‹ç¢¼: ${res.status}`, 'info');
                    log(`  å›æ‡‰: ${JSON.stringify(data).substring(0, 200)}...`, 'info');
                    updateTestStatus(3, 'success', 'é€šé');
                } else {
                    log(`âš  æœªé æœŸçš„ç‹€æ…‹ç¢¼: ${res.status}`, 'warning');
                    log(`  å›æ‡‰: ${JSON.stringify(data)}`, 'info');
                    updateTestStatus(3, 'success', 'é€šéï¼ˆæœªé æœŸç‹€æ…‹ï¼‰');
                }
            } catch (e) {
                log(`âœ— æ¸¬è©¦å¤±æ•—: ${e.message}`, 'error');
                updateTestStatus(3, 'failed', 'å¤±æ•—');
            }
        }

        // æ¸¬è©¦ 4: PUT è«‹æ±‚æ²’æœ‰ CSRF token æ‡‰è©²è¢«æ‹’çµ•
        async function test4() {
            log('é–‹å§‹æ¸¬è©¦ 4: PUT è«‹æ±‚æ²’æœ‰ CSRF token æ‡‰è©²è¢«æ‹’çµ•...', 'info');
            try {
                // å…ˆå–å¾—ä¸€å€‹ä½¿ç”¨è€… IDï¼ˆå‡è¨­è‡³å°‘æœ‰ä¸€å€‹ä½¿ç”¨è€…ï¼‰
                const getRes = await fetch('/api/users?pageSize=1', {
                    credentials: 'include'
                });
                
                if (!getRes.ok) {
                    log(`âš  ç„¡æ³•å–å¾—ä½¿ç”¨è€…åˆ—è¡¨ï¼Œè·³éæ­¤æ¸¬è©¦`, 'warning');
                    updateTestStatus(4, 'failed', 'è·³é');
                    return;
                }
                
                const getData = await getRes.json();
                if (!getData.data || getData.data.length === 0) {
                    log(`âš  æ²’æœ‰ä½¿ç”¨è€…å¯ä»¥æ¸¬è©¦ï¼Œè·³éæ­¤æ¸¬è©¦`, 'warning');
                    updateTestStatus(4, 'failed', 'è·³é');
                    return;
                }
                
                const userId = getData.data[0].id;
                log(`ä½¿ç”¨ä½¿ç”¨è€… ID: ${userId} é€²è¡Œæ¸¬è©¦`, 'info');
                
                const res = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                        // æ•…æ„ä¸åŠ å…¥ X-CSRF-Token
                    },
                    body: JSON.stringify({
                        name: 'æ¸¬è©¦åç¨±'
                    })
                });
                
                const data = await res.json();
                
                if (res.status === 403 && (data.error && data.error.includes('CSRF'))) {
                    log(`âœ“ æ¸¬è©¦é€šé: PUT è«‹æ±‚æ²’æœ‰ token è¢«æ­£ç¢ºæ‹’çµ• (403)`, 'success');
                    log(`  éŒ¯èª¤è¨Šæ¯: ${data.error}`, 'info');
                    updateTestStatus(4, 'success', 'é€šé');
                } else {
                    log(`âœ— æ¸¬è©¦å¤±æ•—: é æœŸ 403 CSRF éŒ¯èª¤ï¼Œä½†æ”¶åˆ°ç‹€æ…‹ç¢¼ ${res.status}`, 'error');
                    log(`  å›æ‡‰: ${JSON.stringify(data)}`, 'error');
                    updateTestStatus(4, 'failed', 'å¤±æ•—');
                }
            } catch (e) {
                log(`âœ— æ¸¬è©¦å¤±æ•—: ${e.message}`, 'error');
                updateTestStatus(4, 'failed', 'å¤±æ•—');
            }
        }

        // æ¸¬è©¦ 5: DELETE è«‹æ±‚æ²’æœ‰ CSRF token æ‡‰è©²è¢«æ‹’çµ•
        async function test5() {
            log('é–‹å§‹æ¸¬è©¦ 5: DELETE è«‹æ±‚æ²’æœ‰ CSRF token æ‡‰è©²è¢«æ‹’çµ•...', 'info');
            log(`âš  æ³¨æ„: æ­¤æ¸¬è©¦ä¸æœƒå¯¦éš›åˆªé™¤è³‡æ–™ï¼Œåªæ¸¬è©¦ CSRF ä¿è­·`, 'warning');
            
            try {
                // å…ˆå–å¾—ä¸€å€‹ä½¿ç”¨è€… ID
                const getRes = await fetch('/api/users?pageSize=1', {
                    credentials: 'include'
                });
                
                if (!getRes.ok) {
                    log(`âš  ç„¡æ³•å–å¾—ä½¿ç”¨è€…åˆ—è¡¨ï¼Œè·³éæ­¤æ¸¬è©¦`, 'warning');
                    updateTestStatus(5, 'failed', 'è·³é');
                    return;
                }
                
                const getData = await getRes.json();
                if (!getData.data || getData.data.length === 0) {
                    log(`âš  æ²’æœ‰ä½¿ç”¨è€…å¯ä»¥æ¸¬è©¦ï¼Œè·³éæ­¤æ¸¬è©¦`, 'warning');
                    updateTestStatus(5, 'failed', 'è·³é');
                    return;
                }
                
                const userId = getData.data[0].id;
                log(`ä½¿ç”¨ä½¿ç”¨è€… ID: ${userId} é€²è¡Œæ¸¬è©¦`, 'info');
                
                const res = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                        // æ•…æ„ä¸åŠ å…¥ X-CSRF-Token
                    }
                });
                
                const data = await res.json();
                
                if (res.status === 403 && (data.error && data.error.includes('CSRF'))) {
                    log(`âœ“ æ¸¬è©¦é€šé: DELETE è«‹æ±‚æ²’æœ‰ token è¢«æ­£ç¢ºæ‹’çµ• (403)`, 'success');
                    log(`  éŒ¯èª¤è¨Šæ¯: ${data.error}`, 'info');
                    updateTestStatus(5, 'success', 'é€šé');
                } else {
                    log(`âœ— æ¸¬è©¦å¤±æ•—: é æœŸ 403 CSRF éŒ¯èª¤ï¼Œä½†æ”¶åˆ°ç‹€æ…‹ç¢¼ ${res.status}`, 'error');
                    log(`  å›æ‡‰: ${JSON.stringify(data)}`, 'error');
                    updateTestStatus(5, 'failed', 'å¤±æ•—');
                }
            } catch (e) {
                log(`âœ— æ¸¬è©¦å¤±æ•—: ${e.message}`, 'error');
                updateTestStatus(5, 'failed', 'å¤±æ•—');
            }
        }

        // æ¸¬è©¦ 6: ç™»å…¥è·¯ç”±ä¸éœ€è¦ CSRF token
        async function test6() {
            log('é–‹å§‹æ¸¬è©¦ 6: ç™»å…¥è·¯ç”±ä¸éœ€è¦ CSRF token...', 'info');
            log(`âš  æ³¨æ„: æ­¤æ¸¬è©¦ä½¿ç”¨éŒ¯èª¤çš„æ†‘è­‰ï¼Œé æœŸç™»å…¥å¤±æ•—ä½†ä¸æ˜¯ CSRF éŒ¯èª¤`, 'warning');
            
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                        // æ•…æ„ä¸åŠ å…¥ X-CSRF-Token
                    },
                    body: JSON.stringify({
                        username: 'test_csrf_' + Date.now(),
                        password: 'WrongPassword123'
                    })
                });
                
                const data = await res.json();
                
                // ç™»å…¥è·¯ç”±æ‡‰è©²æ­£å¸¸é‹ä½œï¼ˆç™»å…¥å¤±æ•—æ˜¯æ­£å¸¸çš„ï¼‰ï¼Œä½†ä¸æ‡‰è©²æ˜¯ CSRF éŒ¯èª¤
                if (res.status === 403 && data.error && data.error.includes('CSRF')) {
                    log(`âœ— æ¸¬è©¦å¤±æ•—: ç™»å…¥è·¯ç”±ä¸æ‡‰è©²éœ€è¦ CSRF tokenï¼Œä½†æ”¶åˆ° CSRF éŒ¯èª¤`, 'error');
                    updateTestStatus(6, 'failed', 'å¤±æ•—');
                } else {
                    log(`âœ“ æ¸¬è©¦é€šé: ç™»å…¥è·¯ç”±ä¸éœ€è¦ CSRF token`, 'success');
                    log(`  ç‹€æ…‹ç¢¼: ${res.status}`, 'info');
                    log(`  å›æ‡‰: ${JSON.stringify(data).substring(0, 200)}...`, 'info');
                    updateTestStatus(6, 'success', 'é€šé');
                }
            } catch (e) {
                log(`âœ— æ¸¬è©¦å¤±æ•—: ${e.message}`, 'error');
                updateTestStatus(6, 'failed', 'å¤±æ•—');
            }
        }

        // æ¸¬è©¦ 7: å‰ç«¯è‡ªå‹•å–å¾— CSRF token
        async function test7() {
            log('é–‹å§‹æ¸¬è©¦ 7: å‰ç«¯è‡ªå‹•å–å¾— CSRF token...', 'info');
            try {
                const token = await getCsrfToken();
                if (token) {
                    log(`âœ“ æ¸¬è©¦é€šé: æˆåŠŸå–å¾— CSRF token`, 'success');
                    log(`  Token: ${token.substring(0, 30)}...`, 'info');
                    updateTestStatus(7, 'success', 'é€šé');
                } else {
                    log(`âœ— æ¸¬è©¦å¤±æ•—: ç„¡æ³•å–å¾— CSRF token`, 'error');
                    updateTestStatus(7, 'failed', 'å¤±æ•—');
                }
            } catch (e) {
                log(`âœ— æ¸¬è©¦å¤±æ•—: ${e.message}`, 'error');
                updateTestStatus(7, 'failed', 'å¤±æ•—');
            }
        }

        // å¿«é€Ÿæ¸¬è©¦å‡½æ•¸
        async function testWithoutToken() {
            clearResults();
            log('=== æ¸¬è©¦æ²’æœ‰ CSRF Token çš„ POST è«‹æ±‚ ===', 'info');
            await test2();
        }

        async function testWithToken() {
            clearResults();
            log('=== æ¸¬è©¦æœ‰ CSRF Token çš„ POST è«‹æ±‚ ===', 'info');
            await test3();
        }

        async function testGetRequest() {
            clearResults();
            log('=== æ¸¬è©¦ GET è«‹æ±‚ï¼ˆä¸éœ€è¦ Tokenï¼‰===', 'info');
            await test1();
        }

        async function runAllTests() {
            clearResults();
            log('=== é–‹å§‹åŸ·è¡Œæ‰€æœ‰ CSRF æ¸¬è©¦ ===', 'info');
            log('è«‹ç¨å€™ï¼Œæ¸¬è©¦å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“...', 'info');
            
            await test1();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test2();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test3();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test4();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test5();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test6();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test7();
            
            log('=== æ‰€æœ‰æ¸¬è©¦å®Œæˆ ===', 'info');
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.addEventListener('load', async () => {
            try {
                const res = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                const data = await res.json();
                if (!data.isLogin) {
                    log('âš  è­¦å‘Š: æ‚¨ä¼¼ä¹å°šæœªç™»å…¥ç³»çµ±ã€‚è«‹å…ˆç™»å…¥å¾Œå†é€²è¡Œæ¸¬è©¦ã€‚', 'warning');
                    log('   æŸäº›æ¸¬è©¦å¯èƒ½éœ€è¦ç™»å…¥æ‰èƒ½æ­£å¸¸åŸ·è¡Œã€‚', 'warning');
                } else {
                    log(`âœ“ å·²ç™»å…¥ç‚º: ${data.name || data.username} (${data.role})`, 'success');
                }
            } catch (e) {
                log(`âš  ç„¡æ³•æª¢æŸ¥ç™»å…¥ç‹€æ…‹: ${e.message}`, 'warning');
            }
        });
    </script>
</body>
</html>
